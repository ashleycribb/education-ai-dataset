from databases import Database
from .config import DATABASE_URL

# Global database instance
# The actual connection is managed by startup/shutdown events in main.py
database = Database(str(DATABASE_URL))

async def connect_db():
    """Connects to the database."""
    await database.connect()
    print("INFO:     Database connection established (MCP Server).")


async def disconnect_db():
    """Disconnects from the database."""
    await database.disconnect()
    print("INFO:     Database connection closed (MCP Server).")


async def create_mcp_contexts_table_if_not_exists():
    # pgcrypto might not be strictly needed for mcp_contexts if it uses TEXT PK,
    # but good for consistency if other tables in the DB use UUIDs generated by it.
    # For this table, TEXT PRIMARY KEY is used, so pgcrypto for uuid_generate_v4() is not directly used by this DDL.
    # However, if other tables were to use UUID PKs with default uuid_generate_v4(), it would be relevant.
    # The DDL in the prompt for raw_xapi_statements *does* use it.
    create_extension_query = """CREATE EXTENSION IF NOT EXISTS "pgcrypto";"""

    create_table_query = """
    CREATE TABLE IF NOT EXISTS mcp_contexts (
        context_id TEXT PRIMARY KEY,
        model_id TEXT,
        user_id TEXT,
        context_payload JSONB NOT NULL,
        last_updated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
    );"""
    # Optional: Add indexes here if desired
    create_idx_model_id_query = "CREATE INDEX IF NOT EXISTS idx_mcp_contexts_model_id ON mcp_contexts (model_id);"
    create_idx_user_id_query = "CREATE INDEX IF NOT EXISTS idx_mcp_contexts_user_id ON mcp_contexts (user_id);"


    # This function will be called after database.connect() in main.py's startup,
    # so we can assume 'database.is_connected' is True.

    async with database.transaction(): # Use transaction for DDL block
        try:
            # pgcrypto is not strictly needed by *this* table's DDL if context_id is TEXT and not UUID generated by DB.
            # However, it's good practice if other parts of the system might use UUIDs generated by pgcrypto.
            # For this specific table, it's optional.
            await database.execute(query=create_extension_query)
            print("INFO:     Ensured pgcrypto extension exists or attempted creation (MCP Server).")
        except Exception as e:
            # Log this warning, but don't let it stop table creation
            print(f"WARNING:  Could not ensure pgcrypto extension. Error: {e} (MCP Server)")

        await database.execute(query=create_table_query)
        print("INFO:     Ensured mcp_contexts table exists (MCP Server).")

        # Creating optional indexes
        await database.execute(query=create_idx_model_id_query)
        await database.execute(query=create_idx_user_id_query)
        print("INFO:     Ensured indexes on mcp_contexts table exist (MCP Server).")

# Note: Proper migrations (e.g., with Alembic) are recommended for production
# instead of relying solely on CREATE TABLE IF NOT EXISTS in application startup.
# This setup is for development convenience.
